<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FTS Wallet Bot - Wallet Connection</title>
    <!-- Ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: #f4f4f4;
      }
      #app {
        text-align: center;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      button,
      input {
        padding: 10px;
        margin: 10px;
        border: none;
        border-radius: 5px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
      input {
        background: white;
        color: black;
        border: 1px solid #ccc;
        width: 80%;
        padding: 8px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <h1>FTS Wallet Bot</h1>
      <button id="connect-wallet-button">Connect Wallet</button>
      <button id="disconnect-wallet-button" style="display:none;">Disconnect Wallet</button>
      <p>Connected Wallet: <span id="connected-wallet">Not connected</span></p>
      <p>Token Balance: <span id="balance-value">0</span> FTS</p>

      <h3>Send FTS Tokens</h3>
      <input type="text" id="recipient-address" placeholder="Recipient Address" />
      <input type="text" id="token-amount" placeholder="Amount to Send" />
      <button id="send-tokens-button">Send Tokens</button>
    </div>

    <script>
      // CONFIGURAZIONE DEL TOKEN
      const TOKEN_CONTRACT_ADDRESS = "0xF87993C72C40268FF93989810192e575D17CAfb0";
      const TOKEN_ABI = [
        "function transfer(address to, uint256 amount) public returns (bool)",
        "function balanceOf(address owner) public view returns (uint256)"
      ];

      let provider, signer, walletAddress, userSigned = false;

      // Rileva se il dispositivo è mobile
      function isMobile() {
        return /Mobi|Android|iPhone/i.test(navigator.userAgent);
      }

      // Rileva se l'utente sta utilizzando il DApp Browser di Trust Wallet
      // (di solito l'user agent contiene "Trust")
      function isTrustWalletBrowser() {
        return /Trust/i.test(navigator.userAgent);
      }

      // Se siamo su mobile e non siamo già nel DApp Browser di Trust Wallet, 
      // forziamo il reindirizzamento al deep link del DApp Browser di Trust Wallet.
      // Il deep link "trust://browser_open?url=..." aprirà la pagina nell'app, se installata.
      if (isMobile() && !isTrustWalletBrowser()) {
        console.log("Non siamo nel DApp Browser di Trust Wallet; reindirizzo tramite deep link...");
        window.location.href = "trust://browser_open?url=" + encodeURIComponent(window.location.href);
      }

      async function connectWallet() {
        try {
          // Se esiste un provider iniettato (ad es. MetaMask o Trust Wallet DApp Browser), lo usiamo
          if (window.ethereum) {
            console.log("Utilizzo provider iniettato...");
            provider = new ethers.BrowserProvider(window.ethereum, "any");
            await provider.send("eth_requestAccounts", []);
          } else {
            // Questo ramo teoricamente non dovrebbe essere raggiunto su mobile,
            // perché abbiamo già reindirizzato all'apertura tramite Trust Wallet.
            console.log("Provider iniettato non trovato; impossibile connettersi.");
            alert("Impossibile connettersi al wallet. Verifica di usare il DApp Browser di Trust Wallet.");
            return;
          }

          signer = await provider.getSigner();
          walletAddress = await signer.getAddress();
          console.log("Wallet connesso:", walletAddress);
          alert("Wallet connesso! Procedi con la firma del messaggio per autorizzare la connessione.");
          await requestSignature();
        } catch (error) {
          console.error("Errore durante la connessione al wallet:", error);
          alert("Impossibile connettersi al wallet. Riprova o verifica il funzionamento dell'app.");
        }
      }

      async function requestSignature() {
        try {
          // Breve delay per sicurezza
          await new Promise((resolve) => setTimeout(resolve, 1500));
          const message = "Authorize FTS Wallet Bot connection";
          const signature = await signer.signMessage(message);
          console.log("Wallet autorizzato con firma:", signature);
          userSigned = true;
          updateUI();
          getTokenBalance();
        } catch (error) {
          console.error("Richiesta di firma fallita:", error);
          alert("Autorizzazione fallita. Firma la richiesta per procedere.");
          disconnectWallet();
        }
      }

      async function getTokenBalance() {
        if (!signer || !walletAddress) return;
        try {
          const tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, provider);
          const balance = await tokenContract.balanceOf(walletAddress);
          document.getElementById("balance-value").textContent = ethers.formatUnits(balance, 18);
        } catch (error) {
          console.error("Errore nel recupero del saldo token:", error);
        }
      }

      async function sendTokens() {
        if (!signer || !userSigned) {
          alert("Prima collega ed autorizza il wallet.");
          return;
        }
        const recipient = document.getElementById("recipient-address").value;
        const amount = document.getElementById("token-amount").value;
        if (!recipient || !amount) {
          alert("Inserisci indirizzo del destinatario e importo.");
          return;
        }
        try {
          const tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);
          const tx = await tokenContract.transfer(recipient, ethers.parseUnits(amount, 18));
          await tx.wait();
          alert("Transazione completata con successo!");
          getTokenBalance();
        } catch (error) {
          console.error("Errore durante l'invio dei token:", error);
          alert("Transazione fallita.");
        }
      }

      function disconnectWallet() {
        walletAddress = null;
        userSigned = false;
        provider = null;
        updateUI();
      }

      function updateUI() {
        if (walletAddress && userSigned) {
          document.getElementById("connected-wallet").textContent = walletAddress;
          document.getElementById("connect-wallet-button").style.display = "none";
          document.getElementById("disconnect-wallet-button").style.display = "inline-block";
        } else {
          document.getElementById("connected-wallet").textContent = "Not connected";
          document.getElementById("balance-value").textContent = "0";
          document.getElementById("connect-wallet-button").style.display = "inline-block";
          document.getElementById("disconnect-wallet-button").style.display = "none";
        }
      }

      document.getElementById("connect-wallet-button").addEventListener("click", connectWallet);
      document.getElementById("send-tokens-button").addEventListener("click", sendTokens);
      document.getElementById("disconnect-wallet-button").addEventListener("click", disconnectWallet);
    </script>
  </body>
</html>
