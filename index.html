<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Interazione Token FTS - WalletConnect</title>
  <!-- ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>
  <!-- Web3Modal -->
  <script src="https://unpkg.com/web3modal@1.9.5/dist/index.js"></script>
  <!-- WalletConnect Provider -->
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0; padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 15px;
      margin: 5px 0;
      background: #2979ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    form {
      background: #fff;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
    }
    label, input {
      display: block;
      margin: 5px 0;
    }
    #transferStatus {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Token FTS su BNB Chain</h1>

    <!-- Sezione Connessione -->
    <button id="connectButton">Collega Wallet</button>
    <div id="walletInfo"></div>
    
    <!-- Sezione per Info Token -->
    <div id="tokenInfoSection" style="display:none;">
      <h2>Info Token</h2>
      <p id="tokenName"></p>
      <p id="tokenSymbol"></p>
    </div>

    <!-- Sezione per il saldo -->
    <div id="balanceSection" style="display:none;">
      <h2>Saldo Token</h2>
      <button id="getBalanceButton">Mostra Saldo</button>
      <div id="balanceDisplay"></div>
    </div>

    <!-- Sezione per il trasferimento -->
    <div id="transferSection" style="display:none;">
      <h2>Trasferisci Token</h2>
      <form id="transferForm">
        <label for="recipient">Indirizzo destinatario</label>
        <input type="text" id="recipient" placeholder="0x..." required />
        
        <label for="amount">Quantità</label>
        <input type="number" step="any" id="amount" required />
        
        <button type="submit">Invia</button>
      </form>
      <div id="transferStatus"></div>
    </div>
  </div>

  <script>
    /******************************************
     * CONFIGURAZIONE
     ******************************************/
    const TOKEN_CONTRACT_ADDRESS = "0xF87993C72C40268FF93989810192e575D17CAfb0";
    const TOKEN_ABI = [
      "function transfer(address to, uint256 amount) public returns (bool)",
      "function balanceOf(address owner) public view returns (uint256)",
      "function decimals() public view returns (uint8)",
      "function name() public view returns (string)",
      "function symbol() public view returns (string)"
    ];
    const BNB_CHAIN_ID = 56; // BSC Mainnet

    // Riferimenti a elementi del DOM
    const connectButton = document.getElementById("connectButton");
    const walletInfo = document.getElementById("walletInfo");
    const tokenInfoSection = document.getElementById("tokenInfoSection");
    const tokenNameEl = document.getElementById("tokenName");
    const tokenSymbolEl = document.getElementById("tokenSymbol");
    const balanceSection = document.getElementById("balanceSection");
    const getBalanceButton = document.getElementById("getBalanceButton");
    const balanceDisplay = document.getElementById("balanceDisplay");
    const transferSection = document.getElementById("transferSection");
    const transferForm = document.getElementById("transferForm");
    const transferStatus = document.getElementById("transferStatus");

    // Variabili globali
    let web3Modal;
    let provider;       // provider generico iniettatato da Web3Modal
    let ethersProvider; // provider di ethers.js
    let signer;         // signer ethers (account collegato)
    let tokenContract;  // istanza del contratto FTS

    /******************************************
     * INIZIALIZZA WEB3MODAL + WALLETCONNECT
     ******************************************/
    function init() {
      // Config del provider WalletConnect
      const walletConnectProvider = {
        package: window.WalletConnectProvider.default,
        options: {
          rpc: {
            56: "https://bsc-dataseed.binance.org/",
            97: "https://data-seed-prebsc-1-s1.binance.org:8545/" // se vuoi aggiungere la testnet
          },
          chainId: BNB_CHAIN_ID
        }
      };

      // Config Web3Modal
      web3Modal = new window.Web3Modal.default({
        cacheProvider: false, // se true, ricorda l'ultima connessione
        providerOptions: {
          walletconnect: walletConnectProvider
        },
        disableInjectedProvider: false  // se fosse true, ignora MetaMask injection
      });
    }

    /******************************************
     * FUNZIONE: COLLEGA WALLET
     ******************************************/
    async function connectWallet() {
      try {
        // Mostra popup Web3Modal (scegli wallet)
        provider = await web3Modal.connect();
        
        // Forziamo Ethers a usare il provider appena ottenuto
        ethersProvider = new ethers.providers.Web3Provider(provider);
        signer = ethersProvider.getSigner();
        
        // Verifica la chain
        const network = await ethersProvider.getNetwork();
        if (network.chainId !== BNB_CHAIN_ID) {
          alert("Attenzione: Non sei su BNB Chain (Mainnet).");
          // Puoi gestire qui la richiesta di switch, 
          // ma con WalletConnect non sempre è possibile forzarlo come con MetaMask injection.
        }

        // Mostra info di base
        const userAddress = await signer.getAddress();
        walletInfo.innerText = "Wallet collegato: " + userAddress;

        // Inizializza il contratto
        tokenContract = new ethers.Contract(
          TOKEN_CONTRACT_ADDRESS,
          TOKEN_ABI,
          signer
        );

        // Mostra sezioni
        tokenInfoSection.style.display = "block";
        balanceSection.style.display = "block";
        transferSection.style.display = "block";

        // Carica il nome e il simbolo
        const [name, symbol] = await Promise.all([
          tokenContract.name(),
          tokenContract.symbol()
        ]);
        tokenNameEl.innerText = "Nome: " + name;
        tokenSymbolEl.innerText = "Simbolo: " + symbol;

      } catch (err) {
        console.error("Errore connessione wallet:", err);
        alert("Connessione al wallet annullata o fallita.");
      }
    }

    /******************************************
     * FUNZIONE: MOSTRA SALDO
     ******************************************/
    async function showBalance() {
      if (!tokenContract) {
        alert("Devi prima collegare il wallet.");
        return;
      }
      try {
        const userAddress = await signer.getAddress();
        const decimals = await tokenContract.decimals();
        let balance = await tokenContract.balanceOf(userAddress);
        balance = ethers.utils.formatUnits(balance, decimals);
        balanceDisplay.innerText = "Saldo FTS: " + balance;
      } catch (err) {
        console.error("Errore nel recuperare il saldo:", err);
        alert("Impossibile ottenere il saldo.");
      }
    }

    /******************************************
     * FUNZIONE: INVIA TOKEN
     ******************************************/
    async function transferTokens(event) {
      event.preventDefault();
      if (!tokenContract) {
        alert("Collega prima il wallet.");
        return;
      }
      const recipient = document.getElementById("recipient").value;
      const amount = document.getElementById("amount").value;
      
      if (!ethers.utils.isAddress(recipient)) {
        alert("Indirizzo destinatario non valido.");
        return;
      }
      if (!amount || isNaN(amount)) {
        alert("Inserisci un importo valido.");
        return;
      }
      
      try {
        transferStatus.innerText = "";
        transferStatus.style.color = "black";

        const decimals = await tokenContract.decimals();
        const amountParsed = ethers.utils.parseUnits(amount, decimals);

        // Invia la transazione di trasferimento
        const tx = await tokenContract.transfer(recipient, amountParsed);
        transferStatus.innerText = "Transazione inviata. Tx Hash: " + tx.hash;
        transferStatus.style.color = "blue";
        // Aspetta la conferma on-chain
        await tx.wait();
        transferStatus.innerText = "Transazione confermata!";
        transferStatus.style.color = "green";
      } catch (err) {
        console.error("Errore invio token:", err);
        transferStatus.innerText = "Transazione fallita: " + (err.message || err);
        transferStatus.style.color = "red";
      }
    }

    /******************************************
     * EVENT LISTENERS
     ******************************************/
    window.addEventListener('load', () => {
      init();
      connectButton.addEventListener('click', connectWallet);
      getBalanceButton.addEventListener('click', showBalance);
      transferForm.addEventListener('submit', transferTokens);
    });
  </script>
</body>
</html>
