<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FTS Wallet Bot - Connessione Wallet</title>
  <!-- ethers.js v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect Ethereum Provider v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.0.7/dist/ethereum-provider.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    #app {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    button,
    input {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
    }
    .button-enabled {
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }
    .button-disabled {
      background-color: #ccc;
      color: #fff;
      cursor: default;
    }
    input {
      width: 80%;
      border: 1px solid #ccc;
      color: #000;
    }
    #status-message {
      font-size: 14px;
      margin-top: 5px;
      min-height: 20px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>FTS Wallet Bot</h1>
    <p>Wallet Connesso: <span id="connected-wallet">Non connesso</span></p>
    <p id="status-message"></p>

    <!-- Pulsanti -->
    <button id="connect-wallet-button" class="button-enabled" onclick="connectWallet()">Connect Wallet</button>
    <button id="deep-link-button" class="button-enabled" onclick="forceDeepLink()">Apri Trust</button>

    <p>Saldo Token: <span id="balance-value">0</span> <span id="token-symbol">FTS</span></p>
  </div>

  <script>
    /***************** CONFIGURAZIONE *****************/
    // Indirizzo del contratto FTS sulla rete BNB
    const TOKEN_CONTRACT_ADDRESS = "0xF87993C72C40268FF93989810192e575D17CAfb0";
    // ABI basata sullo smart contract fornito
    const TOKEN_ABI = [
      "function transfer(address to, uint256 amount) public returns (bool)",
      "function balanceOf(address owner) public view returns (uint256)",
      "function decimals() public view returns (uint8)",
      "function name() public view returns (string)",
      "function symbol() public view returns (string)"
    ];

    /***************** VARIABILI GLOBALI *****************/
    let ethersProvider;   // Provider gestito da ethers.js
    let signer;
    let walletAddress;
    let walletConnected = false;
    let tokenContract;
    let tokenDecimals = 18;  // Valore di default, verrà aggiornato dal contratto
    let tokenSymbol = "FTS"; // Valore di default, verrà aggiornato dal contratto

    /***************** FUNZIONI UTILITY *****************/
    // Aggiorna il messaggio di stato sulla UI
    function updateStatus(message, isError = false) {
      const statusEl = document.getElementById("status-message");
      statusEl.textContent = message;
      statusEl.style.color = isError ? "red" : "green";
      console.log(message);
    }

    // Rileva se l'utente sta utilizzando un dispositivo mobile
    function isMobile() {
      return /mobile|android|iphone/i.test(navigator.userAgent.toLowerCase());
    }

    // Mostra o nasconde il pulsante per il deep link a Trust Wallet (solo su mobile)
    function updateButtonVisibility() {
      const deepLinkBtn = document.getElementById("deep-link-button");
      deepLinkBtn.style.display = isMobile() ? "inline-block" : "none";
    }

    // Deep link per aprire Trust Wallet (su mobile)
    function forceDeepLink() {
      const deepLink = `trust://open_url?url=${encodeURIComponent(window.location.href)}`;
      updateStatus("Reindirizzamento a Trust Wallet...");
      window.location.href = deepLink;
    }

    /***************** CONNESSIONE DEL WALLET *****************/
    async function connectWallet() {
      // 1. Tentativo con provider iniettato (MetaMask, dApp browser, ecc.)
      if (typeof window.ethereum !== "undefined") {
        try {
          updateStatus("Connessione con provider iniettato...");
          const provider = new ethers.BrowserProvider(window.ethereum, "any");
          await provider.send("eth_requestAccounts", []);
          ethersProvider = provider;
          signer = await ethersProvider.getSigner();
          walletAddress = await signer.getAddress();
          walletConnected = true;
          document.getElementById("connected-wallet").textContent = walletAddress;
          updateStatus("Wallet collegato con provider iniettato.");
          tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);
          await loadTokenDetails();
          await getBalance();
          return;
        } catch (error) {
          console.error(error);
          updateStatus("Errore con provider iniettato: " + error.message, true);
          // Se fallisce, si passa al tentativo con WalletConnect v2
        }
      }

      // 2. Se non c'è provider iniettato oppure si è su mobile, si tenta con WalletConnect v2
      if (isMobile()) {
        try {
          updateStatus("Connessione tramite WalletConnect v2 in corso...");
          // Inizializza WalletConnect Ethereum Provider v2
          const wcProvider = await WalletConnectEthereumProvider.init({
            projectId: "d2dbf72ab740e1656b27eefd66a94298",  // Project ID fornito
            chains: [56],           // Rete BNB Chain
            optionalChains: [56],
            showQrModal: true,
          });
          await wcProvider.connect();
          ethersProvider = new ethers.BrowserProvider(wcProvider, "any");
          signer = await ethersProvider.getSigner();
          walletAddress = await signer.getAddress();
          walletConnected = true;
          document.getElementById("connected-wallet").textContent = walletAddress;
          updateStatus("Wallet collegato tramite WalletConnect v2.");
          tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);
          await loadTokenDetails();
          await getBalance();
          return;
        } catch (error) {
          console.error(error);
          updateStatus("Errore con WalletConnect v2: " + error.message, true);
          return;
        }
      }

      updateStatus("Nessun provider disponibile.", true);
    }

    // Recupera i dettagli del token (decimali e simbolo) dallo smart contract FTS
    async function loadTokenDetails() {
      try {
        tokenDecimals = await tokenContract.decimals();
        tokenSymbol = await tokenContract.symbol();
        document.getElementById("token-symbol").textContent = tokenSymbol;
        updateStatus("Dettagli del token caricati.");
      } catch (error) {
        console.error(error);
        updateStatus("Errore nel caricamento dei dettagli del token: " + error.message, true);
      }
    }

    // Recupera il saldo del token FTS per l'indirizzo connesso
    async function getBalance() {
      if (!tokenContract || !walletAddress) return;
      try {
        updateStatus("Recupero del saldo FTS...");
        const balanceBN = await tokenContract.balanceOf(walletAddress);
        // Formatta il saldo utilizzando il numero di decimali recuperato
        const balance = ethers.formatUnits(balanceBN, tokenDecimals);
        document.getElementById("balance-value").textContent = balance;
        updateStatus("Saldo aggiornato.");
      } catch (error) {
        console.error(error);
        updateStatus("Errore nel recupero del saldo: " + error.message, true);
      }
    }

    /***************** INIZIALIZZAZIONE *****************/
    window.addEventListener("load", function () {
      updateButtonVisibility();
    });
  </script>
</body>
</html>
