<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Token FTS su BNB Chain – Connessione via WalletConnect v2</title>
  <!-- ethers.js (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect v2 Provider (UMD) tramite jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.8.11/dist/umd/index.min.js"></script>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f4f4f4; 
      color: #333;
    }
    .container { 
      max-width: 600px; 
      margin: 0 auto; 
    }
    h1, h2 { 
      text-align: center; 
    }
    button {
      padding: 10px 15px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer;
      background: #2979ff; 
      color: #fff; 
      font-size: 16px; 
      margin: 5px 0;
      width: 100%;
    }
    form { 
      background: #fff; 
      padding: 15px; 
      border-radius: 5px; 
      margin-top: 10px; 
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    label, input {
      display: block; 
      margin: 5px 0;
      font-size: 14px;
    }
    input {
      width: 100%; 
      padding: 8px; 
      border: 1px solid #ccc; 
      border-radius: 4px;
    }
    #status, #balanceDisplay, #transferStatus {
      margin-top: 10px; 
      text-align: center;
      font-size: 14px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Token FTS su BNB Chain</h1>
  
  <!-- Sezione per la connessione -->
  <button id="connectBtn">Collega Wallet (WalletConnect v2)</button>
  <div id="status"></div>

  <!-- Sezione per le informazioni del token -->
  <div id="tokenInfoSection" style="display:none;">
    <h2>Info Token</h2>
    <p id="tokenName"></p>
    <p id="tokenSymbol"></p>
  </div>

  <!-- Sezione per il saldo -->
  <div id="balanceSection" style="display:none;">
    <h2>Saldo Token</h2>
    <button id="getBalanceBtn">Mostra Saldo</button>
    <div id="balanceDisplay"></div>
  </div>

  <!-- Sezione per il trasferimento -->
  <div id="transferSection" style="display:none;">
    <h2>Trasferisci Token</h2>
    <form id="transferForm">
      <label for="recipient">Indirizzo destinatario</label>
      <input type="text" id="recipient" placeholder="0x..." required />

      <label for="amount">Quantità</label>
      <input type="number" step="any" id="amount" placeholder="Inserisci quantità" required />

      <button type="submit">Invia</button>
    </form>
    <div id="transferStatus"></div>
  </div>
</div>

<script>
/***************************************************
 * CONFIGURAZIONI
 ***************************************************/
// Dati del token FTS
const TOKEN_CONTRACT_ADDRESS = "0xF87993C72C40268FF93989810192e575D17CAfb0";
const TOKEN_ABI = [
  "function transfer(address to, uint256 amount) public returns (bool)",
  "function balanceOf(address owner) public view returns (uint256)",
  "function decimals() public view returns (uint8)",
  "function name() public view returns (string)",
  "function symbol() public view returns (string)"
];
// ID della BNB Chain (Mainnet)
const BNB_CHAIN_ID = 56;
// Endpoint RPC ufficiale di BSC
const BNB_RPC_URL = "https://bsc-dataseed.binance.org";

// Il projectId fornito per WalletConnect v2
const WALLETCONNECT_PROJECT_ID = "d2dbf72ab740e1656b27eefd66a94298";

/***************************************************
 * ELEMENTI DEL DOM
 ***************************************************/
const connectBtn         = document.getElementById("connectBtn");
const statusEl           = document.getElementById("status");
const tokenInfoSection   = document.getElementById("tokenInfoSection");
const tokenNameEl        = document.getElementById("tokenName");
const tokenSymbolEl      = document.getElementById("tokenSymbol");
const balanceSection     = document.getElementById("balanceSection");
const getBalanceBtn      = document.getElementById("getBalanceBtn");
const balanceDisplay     = document.getElementById("balanceDisplay");
const transferSection    = document.getElementById("transferSection");
const transferForm       = document.getElementById("transferForm");
const transferStatus     = document.getElementById("transferStatus");

/***************************************************
 * VARIABILI GLOBALI
 ***************************************************/
let wcProvider;        // Provider di WalletConnect v2
let ethersProvider;    // Provider di ethers.js
let signer;            // Signer dell'account collegato
let tokenContract;     // Istanza del contratto ERC-20

/***************************************************
 * FUNZIONE: CONNETTI WALLET CON WALLETCONNECT v2
 ***************************************************/
async function connectWallet() {
  try {
    statusEl.textContent = "Inizializzo WalletConnect v2...";

    // Inizializza il provider di WalletConnect v2 utilizzando l'oggetto globale "WalletConnectEthereumProvider"
    wcProvider = await window.WalletConnectEthereumProvider.init({
      projectId: WALLETCONNECT_PROJECT_ID,
      chains: [BNB_CHAIN_ID],
      optionalChains: [],
      methods: ["eth_sendTransaction", "eth_sign", "personal_sign", "eth_signTypedData"],
      optionalMethods: [],
      showQrModal: true, // Mostra il QR code o deep link se necessario
      rpcMap: {
        [BNB_CHAIN_ID]: BNB_RPC_URL
      }
    });

    statusEl.textContent = "Richiesta di connessione in corso...";
    // Avvia la connessione (vengono mostrati QR code o deep link a seconda del dispositivo)
    await wcProvider.connect();

    // Imposta ethers.js con il provider ottenuto
    ethersProvider = new ethers.providers.Web3Provider(wcProvider);
    signer = ethersProvider.getSigner();

    // Verifica la chain connessa
    const network = await ethersProvider.getNetwork();
    if (network.chainId !== BNB_CHAIN_ID) {
      statusEl.textContent = `Attenzione: il wallet è su chain ${network.chainId} invece di BNB Chain (56).`;
    } else {
      statusEl.textContent = "Wallet connesso correttamente su BNB Chain!";
    }

    // Inizializza il contratto FTS
    tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);

    // Mostra le sezioni di informazioni, saldo e trasferimento
    tokenInfoSection.style.display = "block";
    balanceSection.style.display   = "block";
    transferSection.style.display  = "block";

    // Recupera e mostra le informazioni base del token
    const [name, symbol] = await Promise.all([
      tokenContract.name(),
      tokenContract.symbol()
    ]);
    tokenNameEl.textContent   = "Nome: " + name;
    tokenSymbolEl.textContent = "Simbolo: " + symbol;

  } catch (err) {
    console.error("Errore durante la connessione:", err);
    statusEl.textContent = "Connessione fallita: " + (err.message || err);
  }
}

/***************************************************
 * FUNZIONE: MOSTRA IL SALDO DEL TOKEN
 ***************************************************/
async function showBalance() {
  if (!tokenContract || !signer) {
    alert("Devi prima collegare il wallet via WalletConnect.");
    return;
  }
  try {
    const address = await signer.getAddress();
    const decimals = await tokenContract.decimals();
    let balance = await tokenContract.balanceOf(address);
    balance = ethers.utils.formatUnits(balance, decimals);
    balanceDisplay.textContent = `Saldo FTS: ${balance}`;
  } catch (err) {
    console.error("Errore nel recuperare il saldo:", err);
    alert("Impossibile ottenere il saldo: " + (err.message || err));
  }
}

/***************************************************
 * FUNZIONE: TRASFERISCI TOKEN
 ***************************************************/
async function transferTokens(e) {
  e.preventDefault();
  if (!tokenContract) {
    alert("Collega prima il wallet.");
    return;
  }

  const recipient = document.getElementById("recipient").value;
  const amount    = document.getElementById("amount").value;
  transferStatus.textContent = "";

  if (!ethers.utils.isAddress(recipient)) {
    alert("Indirizzo destinatario non valido.");
    return;
  }
  if (!amount || isNaN(amount)) {
    alert("Inserisci una quantità valida.");
    return;
  }

  try {
    const decimals = await tokenContract.decimals();
    const amountParsed = ethers.utils.parseUnits(amount, decimals);

    // Invia la transazione di trasferimento
    const tx = await tokenContract.transfer(recipient, amountParsed);
    transferStatus.style.color = "blue";
    transferStatus.textContent = `Transazione inviata (hash: ${tx.hash}). Attendere conferma...`;

    // Attendi la conferma on-chain
    await tx.wait();
    transferStatus.style.color = "green";
    transferStatus.textContent = "Transazione confermata!";
  } catch (err) {
    console.error("Errore durante il trasferimento:", err);
    transferStatus.style.color = "red";
    transferStatus.textContent = "Errore: " + (err.message || err);
  }
}

/***************************************************
 * EVENT LISTENERS
 ***************************************************/
connectBtn.addEventListener("click", connectWallet);
getBalanceBtn.addEventListener("click", showBalance);
transferForm.addEventListener("submit", transferTokens);
</script>
</body>
</html>
