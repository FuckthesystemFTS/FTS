<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FTS Token su BNB Chain – WalletConnect v2</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f4f4f4;
        color: #333;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
      }
      h1,
      h2 {
        text-align: center;
      }
      button {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        background: #2979ff;
        color: #fff;
        font-size: 16px;
        margin: 5px 0;
        width: 100%;
      }
      form {
        background: #fff;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      }
      label,
      input {
        display: block;
        margin: 5px 0;
        font-size: 14px;
      }
      input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      #status,
      #balanceDisplay,
      #transferStatus {
        margin-top: 10px;
        text-align: center;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>FTS Token su BNB Chain</h1>
      <!-- Sezione Connessione -->
      <button id="connectBtn">Collega Wallet (WalletConnect v2)</button>
      <div id="status"></div>
      <!-- Sezione Info Token -->
      <div id="tokenInfoSection" style="display: none;">
        <h2>Info Token</h2>
        <p id="tokenName"></p>
        <p id="tokenSymbol"></p>
      </div>
      <!-- Sezione Saldo -->
      <div id="balanceSection" style="display: none;">
        <h2>Saldo Token</h2>
        <button id="getBalanceBtn">Mostra Saldo</button>
        <div id="balanceDisplay"></div>
      </div>
      <!-- Sezione Trasferimento -->
      <div id="transferSection" style="display: none;">
        <h2>Trasferisci Token</h2>
        <form id="transferForm">
          <label for="recipient">Indirizzo destinatario</label>
          <input type="text" id="recipient" placeholder="0x..." required />
          <label for="amount">Quantità</label>
          <input type="number" step="any" id="amount" placeholder="Inserisci quantità" required />
          <button type="submit">Invia</button>
        </form>
        <div id="transferStatus"></div>
      </div>
    </div>

    <!-- Script ES Module: Importiamo i moduli dai rispettivi CDN -->
    <script type="module">
      // Importa ethers.js (ES Module) da jsDelivr
      import { ethers } from "https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.esm.min.js";
      // Importa WalletConnect Ethereum Provider usando unpkg
      import { EthereumProvider } from "https://unpkg.com/@walletconnect/ethereum-provider@2.8.11";

      // CONFIGURAZIONI DEL TOKEN E DELLA RETE
      const TOKEN_CONTRACT_ADDRESS = "0xF87993C72C40268FF93989810192e575D17CAfb0";
      const TOKEN_ABI = [
        "function transfer(address to, uint256 amount) public returns (bool)",
        "function balanceOf(address owner) public view returns (uint256)",
        "function decimals() public view returns (uint8)",
        "function name() public view returns (string)",
        "function symbol() public view returns (string)"
      ];

      const BNB_CHAIN_ID = 56;
      const BNB_RPC_URL = "https://bsc-dataseed.binance.org";
      const WALLETCONNECT_PROJECT_ID = "d2dbf72ab740e1656b27eefd66a94298"; // Sostituisci con il tuo projectId se necessario

      // ELEMENTI DEL DOM
      const connectBtn = document.getElementById("connectBtn");
      const statusEl = document.getElementById("status");
      const tokenInfoSection = document.getElementById("tokenInfoSection");
      const tokenNameEl = document.getElementById("tokenName");
      const tokenSymbolEl = document.getElementById("tokenSymbol");
      const balanceSection = document.getElementById("balanceSection");
      const getBalanceBtn = document.getElementById("getBalanceBtn");
      const balanceDisplay = document.getElementById("balanceDisplay");
      const transferSection = document.getElementById("transferSection");
      const transferForm = document.getElementById("transferForm");
      const transferStatus = document.getElementById("transferStatus");

      let provider, ethersProvider, signer, tokenContract;

      // FUNZIONE: CONNETTI IL WALLET CON WALLETCONNECT V2
      async function connectWallet() {
        try {
          statusEl.textContent = "Connessione in corso con WalletConnect v2...";
          // Inizializza il provider di WalletConnect v2
          provider = await EthereumProvider.init({
            projectId: WALLETCONNECT_PROJECT_ID,
            chains: [BNB_CHAIN_ID],
            rpcMap: { [BNB_CHAIN_ID]: BNB_RPC_URL }
          });
          // Avvia la connessione: su desktop verrà mostrato un QR code, su mobile verrà usato il deep linking
          await provider.connect();
          ethersProvider = new ethers.providers.Web3Provider(provider);
          signer = ethersProvider.getSigner();
          const network = await ethersProvider.getNetwork();
          if (network.chainId !== BNB_CHAIN_ID) {
            statusEl.textContent = `Connesso su chain ${network.chainId} invece che su BNB (56).`;
          } else {
            statusEl.textContent = "Connesso su BNB Chain!";
          }
          // Inizializza il contratto del token FTS
          tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);
          // Visualizza le sezioni nascoste
          tokenInfoSection.style.display = "block";
          balanceSection.style.display = "block";
          transferSection.style.display = "block";
          // Recupera e mostra il nome e il simbolo del token
          const [name, symbol] = await Promise.all([
            tokenContract.name(),
            tokenContract.symbol()
          ]);
          tokenNameEl.textContent = "Nome: " + name;
          tokenSymbolEl.textContent = "Simbolo: " + symbol;
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Connessione fallita: " + err.message;
        }
      }

      // FUNZIONE: MOSTRA IL SALDO DEL TOKEN
      async function showBalance() {
        try {
          if (!tokenContract || !signer) {
            alert("Per favore, collega prima il wallet.");
            return;
          }
          const address = await signer.getAddress();
          const decimals = await tokenContract.decimals();
          const balance = await tokenContract.balanceOf(address);
          balanceDisplay.textContent = "Saldo FTS: " + ethers.utils.formatUnits(balance, decimals);
        } catch (err) {
          console.error(err);
          alert("Impossibile recuperare il saldo: " + err.message);
        }
      }

      // FUNZIONE: TRASFERISCI TOKEN
      async function transferTokens(e) {
        e.preventDefault();
        try {
          if (!tokenContract) {
            alert("Per favore, collega prima il wallet.");
            return;
          }
          const recipient = document.getElementById("recipient").value;
          const amount = document.getElementById("amount").value;
          if (!ethers.utils.isAddress(recipient)) {
            alert("Indirizzo destinatario non valido.");
            return;
          }
          const decimals = await tokenContract.decimals();
          const parsedAmount = ethers.utils.parseUnits(amount, decimals);
          const tx = await tokenContract.transfer(recipient, parsedAmount);
          transferStatus.textContent = "Transazione inviata: " + tx.hash + ". In attesa di conferma...";
          await tx.wait();
          transferStatus.textContent = "Transazione confermata!";
        } catch (err) {
          console.error(err);
          transferStatus.textContent = "Errore: " + err.message;
        }
      }

      // ASSOCIA GLI EVENTI
      connectBtn.addEventListener("click", connectWallet);
      getBalanceBtn.addEventListener("click", showBalance);
      transferForm.addEventListener("submit", transferTokens);
    </script>
  </body>
</html>
