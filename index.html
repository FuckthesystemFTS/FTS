<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FTS Wallet Bot - Connessione Wallet</title>
  
  <!-- Carica ethers.js da jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  
  <!-- Carica inizialmente WalletConnectEthereumProvider da jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2/dist/ethereum-provider.umd.min.js"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
    }
    #app {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    button, input {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
    }
    .button-enabled {
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }
    .button-disabled {
      background-color: #ccc;
      color: #fff;
      cursor: default;
    }
    input {
      width: 80%;
      border: 1px solid #ccc;
      color: #000;
    }
    #status-message {
      font-size: 14px;
      margin-top: 5px;
      min-height: 20px;
    }
  </style>
  
  <script>
    /**
     * Funzione che tenta di caricare la libreria WalletConnectEthereumProvider
     * da una lista di URL (senza versione fissa) in sequenza.
     */
    function loadWalletConnectLibrary(urls) {
      return new Promise((resolve, reject) => {
        let index = 0;
        function loadNext() {
          if (index >= urls.length) {
            reject(new Error("Impossibile caricare WalletConnectEthereumProvider da tutti gli URL."));
            return;
          }
          console.log("Provo a caricare la libreria da:", urls[index]);
          const script = document.createElement('script');
          script.src = urls[index];
          script.onload = () => {
            if (window.WalletConnectEthereumProvider) {
              console.log("Libreria caricata da:", urls[index]);
              resolve(window.WalletConnectEthereumProvider);
            } else {
              console.warn("La libreria non è definita dopo il caricamento da:", urls[index]);
              index++;
              loadNext();
            }
          };
          script.onerror = () => {
            console.error("Errore nel caricamento da:", urls[index]);
            index++;
            loadNext();
          };
          document.head.appendChild(script);
        }
        loadNext();
      });
    }
    
    // All'avvio della pagina controlliamo se la libreria è definita; in caso contrario, attiviamo il fallback.
    window.addEventListener("load", function () {
      if (window.WalletConnectEthereumProvider) {
        console.log("WalletConnectEthereumProvider è già definito:", window.WalletConnectEthereumProvider);
      } else {
        console.warn("WalletConnectEthereumProvider non è definito al primo tentativo. Attivo il fallback...");
        const urlsFallback = [
          "https://unpkg.com/@walletconnect/ethereum-provider/dist/ethereum-provider.umd.min.js",
          "https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider/dist/ethereum-provider.umd.min.js"
        ];
        loadWalletConnectLibrary(urlsFallback)
          .then((lib) => {
            console.log("Fallback riuscito, libreria caricata:", lib);
          })
          .catch((err) => {
            console.error("Errore nel caricamento della libreria via fallback:", err);
          });
      }
    });
  </script>
  
</head>
<body>
  <div id="app">
    <h1>FTS Wallet Bot</h1>
    <p>Wallet Connesso: <span id="connected-wallet">Non connesso</span></p>
    <p id="status-message"></p>
    
    <!-- Pulsanti per le varie azioni -->
    <button id="connect-wallet-button" class="button-enabled" onclick="connectWallet()">Connect Wallet</button>
    <!-- Pulsante per la richiesta manuale di firma -->
    <button id="sign-button" class="button-enabled" onclick="richiediFirma()" style="display:none;">Firma ora</button>
    <button id="deep-link-button" class="button-enabled" onclick="forceDeepLink()">Apri Trust</button>
    
    <p>Saldo Token: <span id="balance-value">0</span> <span id="token-symbol">FTS</span></p>
  </div>
  
  <script>
    /***************** CONFIGURAZIONE DEL CONTRATTO *****************/
    const TOKEN_CONTRACT_ADDRESS = "0xF87993C72C40268FF93989810192e575D17CAfb0";
    const TOKEN_ABI = [
      "function transfer(address to, uint256 amount) public returns (bool)",
      "function balanceOf(address owner) public view returns (uint256)",
      "function decimals() public view returns (uint8)",
      "function name() public view returns (string)",
      "function symbol() public view returns (string)"
    ];
    
    /***************** VARIABILI GLOBALI *****************/
    let ethersProvider, signer, walletAddress, tokenContract;
    let tokenDecimals = 18;
    let tokenSymbol = "FTS";
    
    /***************** FUNZIONI UTILITY *****************/
    function updateStatus(message, isError = false) {
      const statusEl = document.getElementById("status-message");
      statusEl.textContent = message;
      statusEl.style.color = isError ? "red" : "green";
      console.log(message);
    }
    
    function isMobile() {
      return /mobile|android|iphone/i.test(navigator.userAgent.toLowerCase());
    }
    
    function updateButtonVisibility() {
      const deepLinkBtn = document.getElementById("deep-link-button");
      deepLinkBtn.style.display = isMobile() ? "inline-block" : "none";
    }
    
    function forceDeepLink() {
      const deepLink = `trust://open_url?url=${encodeURIComponent(window.location.href)}`;
      updateStatus("Reindirizzamento a Trust Wallet...");
      window.location.href = deepLink;
    }
    
    /***************** CONNESSIONE DEL WALLET *****************/
    async function connectWallet() {
      // 1. Se esiste un provider iniettato (es. MetaMask), usalo.
      if (typeof window.ethereum !== "undefined") {
        try {
          updateStatus("Connessione con provider iniettato...");
          const provider = new ethers.BrowserProvider(window.ethereum, "any");
          await provider.send("eth_requestAccounts", []);
          ethersProvider = provider;
          signer = await ethersProvider.getSigner();
          walletAddress = await signer.getAddress();
          document.getElementById("connected-wallet").textContent = walletAddress;
          updateStatus("Wallet collegato con provider iniettato.");
          
          // Mostra il pulsante per la richiesta di firma manuale
          document.getElementById("sign-button").style.display = "inline-block";
          
          tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);
          await loadTokenDetails();
          await getBalance();
          return;
        } catch (error) {
          console.error(error);
          updateStatus("Errore con provider iniettato: " + error.message, true);
        }
      }
      
      // 2. Se non c'è provider iniettato oppure se l'utente è su mobile, usa WalletConnect v2.
      if (isMobile()) {
        try {
          updateStatus("Connessione tramite WalletConnect v2 in corso...");
          let WalletConnectProvider = (window.WalletConnectEthereumProvider &&
                                       window.WalletConnectEthereumProvider.default) ||
                                       window.WalletConnectEthereumProvider;
          if (!WalletConnectProvider) {
            throw new Error("WalletConnectEthereumProvider non è definito dopo i tentativi di fallback.");
          }
          const wcProvider = await WalletConnectProvider.init({
            projectId: "a56c60368c892e57e3099fa3c35c35db",
            chains: [56],
            optionalChains: [56],
            showQrModal: true,
          });
          await wcProvider.connect();
          ethersProvider = new ethers.BrowserProvider(wcProvider, "any");
          signer = await ethersProvider.getSigner();
          walletAddress = await signer.getAddress();
          document.getElementById("connected-wallet").textContent = walletAddress;
          updateStatus("Wallet collegato tramite WalletConnect v2.");
          
          // Mostra il pulsante per la richiesta di firma manuale
          document.getElementById("sign-button").style.display = "inline-block";
          
          tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);
          await loadTokenDetails();
          await getBalance();
          return;
        } catch (error) {
          console.error(error);
          updateStatus("Errore con WalletConnect v2: " + error.message, true);
          return;
        }
      }
      
      updateStatus("Nessun provider disponibile.", true);
    }
    
    // Funzione per forzare la richiesta di firma manuale (invocata tramite il pulsante "Firma ora")
    async function richiediFirma() {
      try {
        const message = "Autorizza la connessione per visualizzare il saldo FTS.";
        updateStatus("Richiesta firma in corso...");
        const signature = await signer.signMessage(message);
        console.log("Firma ottenuta:", signature);
        updateStatus("Firma eseguita correttamente.");
      } catch (error) {
        console.error("Errore durante la richiesta di firma:", error);
        updateStatus("Firma richiesta non completata: " + error.message, true);
      }
    }
    
    async function loadTokenDetails() {
      try {
        tokenDecimals = await tokenContract.decimals();
        tokenSymbol = await tokenContract.symbol();
        document.getElementById("token-symbol").textContent = tokenSymbol;
        updateStatus("Dettagli del token caricati.");
      } catch (error) {
        console.error(error);
        updateStatus("Errore nel caricamento dei dettagli del token: " + error.message, true);
      }
    }
    
    async function getBalance() {
      if (!tokenContract || !walletAddress) return;
      try {
        updateStatus("Recupero del saldo FTS...");
        const balanceBN = await tokenContract.balanceOf(walletAddress);
        const balance = ethers.formatUnits(balanceBN, tokenDecimals);
        document.getElementById("balance-value").textContent = balance;
        updateStatus("Saldo aggiornato.");
      } catch (error) {
        console.error(error);
        updateStatus("Errore nel recupero del saldo: " + error.message, true);
      }
    }
    
    /***************** INIZIALIZZAZIONE *****************/
    window.addEventListener("load", function () {
      updateButtonVisibility();
    });
  </script>
</body>
</html>
