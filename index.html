<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile WalletConnect - FTS Wallet Bot</title>
  
  <!-- Carica ethers.js dalla CDN (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.0/dist/ethers.umd.min.js"></script>
  
  <!-- Import map: mappa il modulo WalletConnectEthereumProvider all'URL su unpkg -->
  <script type="importmap">
  {
    "imports": {
      "@walletconnect/ethereum-provider": "https://unpkg.com/@walletconnect/ethereum-provider@2.0.9/dist/ethereum-provider.esm.js"
    }
  }
  </script>
  
  <!-- Caricamento dinamico del modulo tramite import map -->
  <script type="module">
    async function getWalletConnectProvider() {
      try {
        // Importa il modulo secondo l'import map
        const module = await import("@walletconnect/ethereum-provider");
        console.log("WalletConnectEthereumProvider importato con successo:", module.default);
        return module.default;
      } catch (err) {
        console.error("Errore durante l'import dinamico:", err);
        throw err;
      }
    }
    // Rendi la funzione disponibile globalmente
    window.getWalletConnectProvider = getWalletConnectProvider;
  </script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    #app {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 90%;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: #fff;
      cursor: pointer;
    }
    #status-message {
      font-size: 14px;
      margin-top: 10px;
      min-height: 20px;
    }
  </style>
  
  <script>
    // Controllo base al caricamento (da usare solo per debug)
    window.addEventListener("load", function () {
      console.log("Pagina caricata. Servi la pagina via HTTPS per funzionare correttamente.");
    });
  </script>
</head>
<body>
  <div id="app">
    <h1>FTS Wallet Bot</h1>
    <p>Wallet Connesso: <span id="connected-wallet">Non connesso</span></p>
    <p id="status-message"></p>
    
    <!-- Pulsante per connettere il wallet -->
    <button onclick="connectWallet()">Connect Wallet</button>
    <!-- Pulsante per richiedere la firma (visibile dopo la connessione) -->
    <button id="sign-button" style="display:none;" onclick="richiediFirma()">Firma ora</button>
    
    <p>Saldo Token: <span id="balance-value">0</span> <span id="token-symbol">FTS</span></p>
  </div>
  
  <script>
    /***************** CONFIGURAZIONE DEL CONTRATTO *****************/
    const TOKEN_CONTRACT_ADDRESS = "0xF87993C72C40268FF93989810192e575D17CAfb0";
    const TOKEN_ABI = [
      "function transfer(address to, uint256 amount) public returns (bool)",
      "function balanceOf(address owner) public view returns (uint256)",
      "function decimals() public view returns (uint8)",
      "function name() public view returns (string)",
      "function symbol() public view returns (string)"
    ];
    
    /***************** VARIABILI GLOBALI *****************/
    let ethersProvider, signer, walletAddress, tokenContract;
    let tokenDecimals = 18;
    let tokenSymbol = "FTS";
    
    /***************** FUNZIONI UTILITY *****************/
    function updateStatus(message, isError = false) {
      const statusEl = document.getElementById("status-message");
      statusEl.textContent = message;
      statusEl.style.color = isError ? "red" : "green";
      console.log(message);
    }
    
    /***************** CONNESSIONE DEL WALLET (SOLO MOBILE) *****************/
    async function connectWallet() {
      try {
        updateStatus("Connessione tramite WalletConnect v2 in corso...");
        // Carica dinamicamente il provider
        const WalletConnectProvider = await window.getWalletConnectProvider();
        if (!WalletConnectProvider) {
          throw new Error("WalletConnectProvider non disponibile.");
        }
        // Inizializza il provider con il project ID e le impostazioni per la rete BNB (56)
        const wcProvider = await WalletConnectProvider.init({
          projectId: "a56c60368c892e57e3099fa3c35c35db",
          chains: [56],
          optionalChains: [56],
          showQrModal: true
        });
        // Connetti il provider (questo aprir√† il QR code o un deep link sul dispositivo mobile)
        await wcProvider.connect();
        // Usa ethers.js per creare un provider compatibile
        ethersProvider = new ethers.BrowserProvider(wcProvider, "any");
        signer = await ethersProvider.getSigner();
        walletAddress = await signer.getAddress();
        document.getElementById("connected-wallet").textContent = walletAddress;
        updateStatus("Wallet collegato tramite WalletConnect v2.");
        // Mostra il pulsante per richiedere la firma
        document.getElementById("sign-button").style.display = "inline-block";
        
        // Crea il contratto per interagire con il token FTS
        tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);
        await loadTokenDetails();
        await getBalance();
      } catch (error) {
        console.error(error);
        updateStatus("Errore nella connessione: " + error.message, true);
      }
    }
    
    // Funzione per richiedere manualmente la firma (utile per forzare l'interazione)
    async function richiediFirma() {
      try {
        const message = "Autorizza la connessione per visualizzare il saldo FTS.";
        updateStatus("Richiesta firma in corso...");
        const signature = await signer.signMessage(message);
        console.log("Firma ottenuta:", signature);
        updateStatus("Firma eseguita correttamente.");
      } catch (error) {
        console.error(error);
        updateStatus("Errore nella firma: " + error.message, true);
      }
    }
    
    // Funzione per caricare i dettagli del token (decimali e simbolo)
    async function loadTokenDetails() {
      try {
        tokenDecimals = await tokenContract.decimals();
        tokenSymbol = await tokenContract.symbol();
        document.getElementById("token-symbol").textContent = tokenSymbol;
        updateStatus("Dettagli del token caricati.");
      } catch (error) {
        console.error(error);
        updateStatus("Errore nel caricamento dei dettagli del token: " + error.message, true);
      }
    }
    
    // Funzione per ottenere il saldo del token FTS
    async function getBalance() {
      try {
        updateStatus("Recupero del saldo FTS...");
        const balanceBN = await tokenContract.balanceOf(walletAddress);
        const balance = ethers.formatUnits(balanceBN, tokenDecimals);
        document.getElementById("balance-value").textContent = balance;
        updateStatus("Saldo aggiornato.");
      } catch (error) {
        console.error(error);
        updateStatus("Errore nel recupero del saldo: " + error.message, true);
      }
    }
  </script>
</body>
</html>
