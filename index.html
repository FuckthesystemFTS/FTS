<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FTS su BNB Chain - WalletConnect v2</title>
  <!-- ethers.js (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect v2 Provider (UMD) -->
  <script src="https://unpkg.com/@walletconnect/ethereum-provider@2.8.11/dist/umd/index.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f4f4;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #2979ff;
      color: #fff;
      font-size: 16px;
      margin: 5px 0;
    }
    form {
      background: #fff;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }
    label, input {
      display: block;
      margin: 5px 0;
    }
    #status, #balanceDisplay, #transferStatus {
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Interazione con Token FTS su BNB Chain</h1>
  
  <!-- Bottone per connettere il wallet via WalletConnect v2 -->
  <button id="connectBtn">Collega Wallet (WC v2)</button>
  <div id="status"></div>

  <!-- Sezione Info Token (nome e simbolo) -->
  <div id="tokenInfoSection" style="display:none;">
    <h2>Info Token FTS</h2>
    <p id="tokenName"></p>
    <p id="tokenSymbol"></p>
  </div>

  <!-- Sezione per il saldo -->
  <div id="balanceSection" style="display:none;">
    <h2>Saldo del Token</h2>
    <button id="getBalanceBtn">Mostra Saldo</button>
    <div id="balanceDisplay"></div>
  </div>

  <!-- Sezione per il trasferimento -->
  <div id="transferSection" style="display:none;">
    <h2>Trasferisci Token</h2>
    <form id="transferForm">
      <label for="recipient">Destinatario</label>
      <input type="text" id="recipient" placeholder="0x..." required />
      <label for="amount">Quantità</label>
      <input type="number" step="any" id="amount" required />
      <button type="submit">Invia</button>
    </form>
    <div id="transferStatus"></div>
  </div>
</div>

<script>
/***************************************************
 * CONFIGURAZIONI E COSTANTI
 ***************************************************/
// Dati del Token FTS su BNB Chain
const TOKEN_CONTRACT_ADDRESS = "0xF87993C72C40268FF93989810192e575D17CAfb0";
const TOKEN_ABI = [
  "function transfer(address to, uint256 amount) public returns (bool)",
  "function balanceOf(address owner) public view returns (uint256)",
  "function decimals() public view returns (uint8)",
  "function name() public view returns (string)",
  "function symbol() public view returns (string)"
];
// BNB Mainnet: chainId 56
const BNB_CHAIN_ID = 56;
const BNB_RPC_URL = "https://bsc-dataseed.binance.org";

// Il tuo Project ID di WalletConnect v2
const WALLETCONNECT_PROJECT_ID = "d2dbf72ab740e1656b27eefd66a94298";

/***************************************************
 * ELEMENTI DEL DOM
 ***************************************************/
const connectBtn         = document.getElementById("connectBtn");
const statusEl           = document.getElementById("status");
const tokenInfoSection   = document.getElementById("tokenInfoSection");
const tokenNameEl        = document.getElementById("tokenName");
const tokenSymbolEl      = document.getElementById("tokenSymbol");
const balanceSection     = document.getElementById("balanceSection");
const getBalanceBtn      = document.getElementById("getBalanceBtn");
const balanceDisplay     = document.getElementById("balanceDisplay");
const transferSection    = document.getElementById("transferSection");
const transferForm       = document.getElementById("transferForm");
const transferStatus     = document.getElementById("transferStatus");

/***************************************************
 * VARIABILI GLOBALI
 ***************************************************/
let wcProvider;       // WalletConnectProvider (v2)
let ethersProvider;   // ethers.js provider
let signer;           // ethers.js signer
let tokenContract;    // Contratto FTS

/***************************************************
 * FUNZIONE: Connetti Wallet con WC v2
 ***************************************************/
async function connectWallet() {
  try {
    statusEl.textContent = "Inizializzo WalletConnect...";

    // 1) Crea il provider di WalletConnect v2
    wcProvider = await window.WalletConnectProvider.EthereumProvider.init({
      projectId: WALLETCONNECT_PROJECT_ID,
      chains: [BNB_CHAIN_ID],
      methods: ["eth_sendTransaction","eth_sign","personal_sign","eth_signTypedData"],
      showQrModal: true, // Mostra il QR code se serve
      rpcMap: {
        [BNB_CHAIN_ID]: BNB_RPC_URL
      }
    });

    // 2) Connetti
    statusEl.textContent = "Richiesta di connessione al wallet...";
    await wcProvider.connect();

    // 3) Inizializza ethers.js con wcProvider
    ethersProvider = new ethers.providers.Web3Provider(wcProvider);
    signer = ethersProvider.getSigner();

    // Verifica la rete
    const network = await ethersProvider.getNetwork();
    if (network.chainId !== BNB_CHAIN_ID) {
      statusEl.textContent = `Attenzione: il wallet è su chain ${network.chainId}, non BNB Chain (56).`;
    } else {
      statusEl.textContent = "Wallet connesso su BNB Chain!";
    }

    // Inizializza il contratto FTS
    tokenContract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, signer);

    // Mostra le sezioni Info, Saldo, Trasferimento
    tokenInfoSection.style.display   = "block";
    balanceSection.style.display     = "block";
    transferSection.style.display    = "block";

    // Recupera e mostra nome e simbolo del token
    const [tokenName, tokenSymbol] = await Promise.all([
      tokenContract.name(),
      tokenContract.symbol()
    ]);
    tokenNameEl.textContent   = "Nome: " + tokenName;
    tokenSymbolEl.textContent = "Simbolo: " + tokenSymbol;
    
  } catch (err) {
    console.error("Errore nella connessione WalletConnect:", err);
    statusEl.textContent = "Connessione fallita: " + (err.message || err);
  }
}

/***************************************************
 * FUNZIONE: Mostra il saldo di FTS
 ***************************************************/
async function showBalance() {
  if (!tokenContract || !signer) {
    alert("Collega prima il wallet tramite WalletConnect.");
    return;
  }
  try {
    // Indirizzo dell'utente
    const userAddress = await signer.getAddress();
    // Decimali del token
    const decimals = await tokenContract.decimals();
    // Saldo in formato bigNumber
    let balance = await tokenContract.balanceOf(userAddress);
    // Converti in formato leggibile
    balance = ethers.utils.formatUnits(balance, decimals);
    balanceDisplay.innerText = `Saldo FTS: ${balance}`;
  } catch (err) {
    console.error("Errore nel recuperare il saldo:", err);
    alert("Errore nel recuperare il saldo: " + (err.message || err));
  }
}

/***************************************************
 * FUNZIONE: Trasferisci token
 ***************************************************/
async function transferTokens(e) {
  e.preventDefault();
  if (!tokenContract) {
    alert("Collega prima il wallet.");
    return;
  }
  transferStatus.textContent = "";

  const recipient = document.getElementById("recipient").value;
  const amount    = document.getElementById("amount").value;

  if (!ethers.utils.isAddress(recipient)) {
    alert("Indirizzo destinatario non valido.");
    return;
  }
  if (!amount || isNaN(amount)) {
    alert("Inserisci una quantità valida.");
    return;
  }

  try {
    // Otteniamo i decimali
    const decimals = await tokenContract.decimals();
    // Convertiamo la quantità in base ai decimali
    const amountParsed = ethers.utils.parseUnits(amount, decimals);

    // Invia transazione
    const tx = await tokenContract.transfer(recipient, amountParsed);
    transferStatus.style.color = "blue";
    transferStatus.textContent = `Transazione inviata (hash: ${tx.hash}). Attendi conferma...`;

    // Attendi la conferma
    await tx.wait();
    transferStatus.style.color = "green";
    transferStatus.textContent = "Transazione confermata!";
  } catch (err) {
    console.error("Errore nella transazione:", err);
    transferStatus.style.color = "red";
    transferStatus.textContent = "Errore: " + (err.message || err);
  }
}

/***************************************************
 * EVENTI
 ***************************************************/
connectBtn.addEventListener("click", connectWallet);
getBalanceBtn.addEventListener("click", showBalance);
transferForm.addEventListener("submit", transferTokens);
</script>
</body>
</html>
